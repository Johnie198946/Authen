# 系统初始化脚本使用说明

## 概述

`init_system.py` 是统一身份认证和权限管理平台的系统初始化脚本。该脚本用于在系统首次部署时创建必要的初始数据，包括超级管理员账号、系统角色和权限、以及根组织节点。

## 功能

该脚本执行以下初始化操作：

1. **创建超级管理员账号**
   - 用户名：`admin`
   - 密码：`123456`
   - 邮箱：`admin@unified-auth.local`
   - 状态：`active`

2. **创建系统权限**
   - 用户管理权限（create, read, update, delete）
   - 角色管理权限（create, read, update, delete）
   - 权限管理权限（create, read）
   - 组织管理权限（create, read, update, delete）
   - 订阅管理权限（create, read, update, delete）
   - 审计日志权限（read）
   - 系统配置权限（read, update）

3. **创建系统角色**
   - `super_admin`：超级管理员，拥有所有权限
   - `admin`：管理员，拥有大部分管理权限
   - `user`：普通用户，拥有基本权限

4. **分配超级管理员角色**
   - 将 `super_admin` 角色分配给超级管理员账号

5. **创建根组织节点**
   - 组织名称：`根组织`
   - 组织路径：`/root`
   - 组织层级：`0`

## 使用方法

### 前提条件

1. 确保数据库服务已启动（PostgreSQL）
2. 确保已配置正确的数据库连接信息（在 `.env` 文件或环境变量中）
3. 确保已安装所有依赖包（`pip install -r requirements.txt`）

### 执行初始化

```bash
# 在项目根目录下执行
python3 scripts/init_system.py
```

### 预期输出

```
============================================================
开始系统初始化...
============================================================

[1/4] 创建超级管理员账号...
✅ 超级管理员账号创建成功
   用户名: admin
   密码: 123456
   用户ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

[2/4] 创建系统权限...
✅ 系统权限创建完成（新建 23 个，已存在 0 个）

[3/4] 创建系统角色...
✅ 角色 'super_admin' 创建成功（包含 23 个权限）
✅ 角色 'admin' 创建成功（包含 11 个权限）
✅ 角色 'user' 创建成功（包含 2 个权限）
✅ 系统角色创建完成（新建 3 个）

[4/4] 为超级管理员分配角色...
✅ 超级管理员角色分配成功

[5/5] 创建根组织节点...
✅ 根组织节点创建成功
   组织名称: 根组织
   组织路径: /root
   组织ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

============================================================
✅ 系统初始化完成！
============================================================

📋 初始化摘要:
   - 超级管理员: admin / 123456
   - 系统权限数: 23
   - 系统角色数: 3
   - 根组织: 根组织

⚠️  重要提示:
   1. 请在首次登录后立即修改超级管理员密码
   2. 超级管理员拥有无限权限，请妥善保管账号
   3. 所有操作都会被记录到审计日志
============================================================
```

## 幂等性

该脚本设计为幂等的，可以安全地多次执行：

- 如果超级管理员账号已存在，将跳过创建
- 如果系统权限已存在，将跳过创建
- 如果系统角色已存在，将跳过创建
- 如果根组织节点已存在，将跳过创建

这意味着即使脚本执行失败，也可以安全地重新运行。

## 安全注意事项

⚠️ **重要安全提示**

1. **立即修改默认密码**
   - 超级管理员的默认密码是 `123456`
   - 这是一个弱密码，仅用于初始化
   - 请在首次登录后立即修改为强密码

2. **保护超级管理员账号**
   - 超级管理员拥有无限权限，可以执行任何操作
   - 请妥善保管超级管理员凭证
   - 建议启用双因素认证（2FA）

3. **审计日志**
   - 所有超级管理员操作都会被记录到审计日志
   - 定期检查审计日志以发现异常活动

4. **生产环境部署**
   - 在生产环境中，建议在初始化后立即禁用或删除默认密码
   - 考虑使用更安全的初始化方式（如环境变量传递密码）

## 测试

该脚本包含完整的单元测试，位于 `tests/test_system_init.py`。

运行测试：

```bash
python3 -m pytest tests/test_system_init.py -v
```

测试覆盖：
- 超级管理员账号创建
- 系统权限创建
- 系统角色创建
- 角色权限分配
- 根组织节点创建
- 幂等性验证
- 完整初始化流程

## 故障排除

### 数据库连接失败

**错误信息：**
```
psycopg2.OperationalError: connection to server at "localhost", port 5432 failed
```

**解决方案：**
1. 确保 PostgreSQL 服务已启动
2. 检查数据库连接配置（`.env` 文件或环境变量）
3. 验证数据库用户权限

### 权限不足

**错误信息：**
```
permission denied for table users
```

**解决方案：**
1. 确保数据库用户有创建表和插入数据的权限
2. 检查数据库迁移是否已执行（`alembic upgrade head`）

### 数据已存在

**行为：**
脚本输出 "⚠️ 已存在，跳过创建"

**说明：**
这是正常行为，表示数据已经初始化过。脚本会跳过已存在的数据，继续执行其他初始化步骤。

## 相关文档

- [需求文档](../.kiro/specs/unified-auth-platform/requirements.md) - 需求 6.1
- [设计文档](../.kiro/specs/unified-auth-platform/design.md)
- [任务列表](../.kiro/specs/unified-auth-platform/tasks.md) - 任务 13.1

## 版本历史

- **v1.0.0** (2024) - 初始版本
  - 创建超级管理员账号
  - 创建系统角色和权限
  - 创建根组织节点
  - 支持幂等执行
